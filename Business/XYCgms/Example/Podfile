# Podfile
# CocoaPods æ’ä»¶æº
source 'https://github.com/CocoaPods/Specs.git'

# å¯ç”¨ Swift åŠ¨æ€æ¡†æ¶
use_frameworks!

# éšè—æ‰€æœ‰ CocoaPods è­¦å‘Š
inhibit_all_warnings!

# å…³é—­ deterministic UUIDsï¼ˆä¾¿äºç‰ˆæœ¬æ§åˆ¶æŸ¥çœ‹å·®å¼‚ï¼‰
install! 'cocoapods', :deterministic_uuids => false


# ================== é…ç½®å¸¸é‡ ==================
# ä¸»å·¥ç¨‹è·¯å¾„ï¼ˆè¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
MAIN_PROJECT_PATH = './XYCgms.xcodeproj'

# åŸºç¡€è·¯å¾„æ˜ å°„
LIB_ROOT = '../../../'
PATHS = {
  basic:  LIB_ROOT + 'Basic/',
  server: LIB_ROOT + 'Server/',
  tool:   LIB_ROOT + 'Tool/',
  business: LIB_ROOT + 'Business/',
  third:  LIB_ROOT + 'Third/'
}

# ================== åŠ¨æ€è·å–ä¸»å·¥ç¨‹å¹³å°ç‰ˆæœ¬ ==================
require 'xcodeproj'

def get_deployment_target(project, platform_symbol, target_key)
  project.targets.each do |target|
    if target.platform_name == platform_symbol
      config = target.build_configurations.first
      return config.build_settings[target_key] if config
    end
  end
  nil
end

ios_deployment_target = nil
watchos_deployment_target = nil

begin
  main_project = Xcodeproj::Project.open(MAIN_PROJECT_PATH)

  ios_deployment_target = get_deployment_target(main_project, :ios, 'IPHONEOS_DEPLOYMENT_TARGET')
  watchos_deployment_target = get_deployment_target(main_project, :watchos, 'WATCHOS_DEPLOYMENT_TARGET')

rescue => e
  puts "âš ï¸ æ— æ³•æ‰“å¼€ä¸»å·¥ç¨‹ #{MAIN_PROJECT_PATH}ï¼Œä½¿ç”¨é»˜è®¤éƒ¨ç½²ç›®æ ‡: #{e.message}"
end

# è®¾ç½®é»˜è®¤å€¼ï¼ˆè‹¥æœªè·å–åˆ°ï¼‰
ios_deployment_target ||= '14.0'
watchos_deployment_target ||= '9.0'

puts "ğŸ“± iOS Deployment Target: #{ios_deployment_target}"
puts "âŒšï¸ watchOS Deployment Target: #{watchos_deployment_target}"


# ================== å…¬å…± Pod å®šä¹‰ ==================
def comPod
  # ä¸»ç»„ä»¶
  pod 'XYCgms', :path => '../'

  # Basic
  pod 'XYExtension', :path => PATHS[:basic] + 'XYExtension/'

  # Server
  pod 'XYLog',             :path => PATHS[:server] + 'XYLog/'
  pod 'XYCoreBluetooth',   :path => PATHS[:server] + 'XYCoreBluetooth/'
  pod 'XYWatchConnectivity', :path => PATHS[:server] + 'XYWatchConnectivity/'
  pod 'XYStorage',         :path => PATHS[:server] + 'XYStorage/'
  pod 'XYNetwork',         :path => PATHS[:server] + 'XYNetwork/'

  # Tool
  pod 'XYUtil',            :path => PATHS[:tool] + 'XYUtil/'

  # Third
  pod 'MTBleCore',         :path => PATHS[:third] + 'MTBleCore/'
  
end


# ================== iOS Targets ==================
target 'XYCgms' do
  platform :ios, ios_deployment_target
  comPod

  target 'XYCgmsTests' do
    inherit! :search_paths
  end

  target 'XYCgmsUITests' do
    inherit! :search_paths
  end
end


# ================== watchOS Targets ==================
target 'XYCgmsWatch Watch App' do
  platform :watchos, watchos_deployment_target
  comPod

  target 'XYCgmsWatch Watch AppTests' do
    inherit! :search_paths
  end

  target 'XYCgmsWatch Watch AppUITests' do
    inherit! :search_paths
  end
end


# ================== å®‰è£…åå¤„ç†ï¼šåŒæ­¥ä¸»å·¥ç¨‹æ„å»ºè®¾ç½® ==================
post_install do |installer|
  begin
    main_project = Xcodeproj::Project.open(MAIN_PROJECT_PATH)
    main_target = main_project.targets.first

    if main_target.nil?
      puts "âš ï¸ ä¸»å·¥ç¨‹æ— æœ‰æ•ˆ targetï¼Œè·³è¿‡ build settings åŒæ­¥"
      return
    end

    main_config = main_target.build_configurations.first
    main_archs = main_config.build_settings['ARCHS']
    main_valid_archs = main_config.build_settings['VALID_ARCHS']

    # éå†æ‰€æœ‰ Pods target
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        # åŒæ­¥ deployment target
        case target.platform_name
        when :ios
          config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = ios_deployment_target
        when :watchos
          config.build_settings['WATCHOS_DEPLOYMENT_TARGET'] = watchos_deployment_target
        end

        # åŒæ­¥æ¶æ„è®¾ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if main_archs
          config.build_settings['ARCHS'] = main_archs
        end
        if main_valid_archs
          config.build_settings['VALID_ARCHS'] = main_valid_archs
        end

        # æ¨èï¼šæ˜ç¡®æŒ‡å®š build active architecture only
        config.build_settings['ONLY_ACTIVE_ARCH'] = main_config.build_settings['ONLY_ACTIVE_ARCH'] || 'YES'
      end
    end

    # ä¿å­˜ Pods é¡¹ç›®
    installer.pods_project.save()

    puts "âœ… Pods é¡¹ç›®å·²æˆåŠŸæ›´æ–°å¹¶åŒæ­¥æ„å»ºè®¾ç½®"

  rescue => e
    puts "âš ï¸ post_install é˜¶æ®µå‘ç”Ÿé”™è¯¯: #{e.message}"
  end
end
